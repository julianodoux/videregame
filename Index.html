<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Controle de Sorvetes</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<style>
    body {
        font-family: Arial, sans-serif;
        background: #f2f2f7;
        padding: 12px;
        color: #333;
        max-width: 480px;
        margin: auto;
    }

    h1 {
        text-align: center;
        margin-bottom: 20px;
        font-size: 26px;
        font-weight: 900;
        color: #222;
    }

    .cat-btn {
        width: 100%;
        background: #007aff;
        color: white;
        padding: 18px;
        font-size: 20px;
        border: none;
        border-radius: 14px;
        margin-top: 15px;
        cursor: pointer;
        font-weight: bold;
        box-shadow: 0 3px 7px rgba(0,0,0,0.15);
    }

    .categoria {
        display: none;
        margin-top: 8px;
        background: #ffffff;
        padding: 14px;
        border-radius: 14px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .item {
        background: #fff;
        padding: 14px;
        margin: 12px 0;
        border-radius: 14px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        transition: 0.2s;
    }

    .item.zero {
        background: #ff4d4d !important;
        color: white !important;
    }

    .nome {
        font-size: 20px;
        font-weight: bold;
    }

    .valor {
        font-size: 16px;
        color: #007aff;
        margin-top: 2px;
        font-weight: bold;
    }

    .restante {
        font-size: 17px;
        margin-top: 4px;
        font-weight: bold;
    }

    .linha {
        display: flex;
        justify-content: space-between;
        margin-top: 14px;
    }

    .controls {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .btn {
        width: 45px;
        height: 45px;
        border-radius: 12px;
        border: none;
        cursor: pointer;
        font-size: 26px;
        font-weight: bold;
    }

    .menos { background: #ff3b30; color: white; }
    .mais  { background: #34c759; color: white; }

    .numero {
        width: 45px;
        text-align: center;
        font-size: 24px;
        font-weight: bold;
    }

    #totalVendas, .caixa-info {
        margin-top: 20px;
        padding: 20px;
        background: #e6fff0;
        border-radius: 16px;
        font-size: 22px;
        text-align: center;
        font-weight: 900;
        color: #0b6b1a;
    }

    #limpar {
        width: 100%;
        background: #ff3b30;
        color: white;
        padding: 18px;
        font-size: 20px;
        border: none;
        border-radius: 14px;
        margin-top: 25px;
        cursor: pointer;
        font-weight: bold;
    }

    #relatorio {
        width: 100%;
        background: #5856d6;
        color: white;
        padding: 18px;
        font-size: 20px;
        border: none;
        border-radius: 14px;
        margin-top: 25px;
        cursor: pointer;
        font-weight: bold;
    }
</style>

<script>
/* ------------------- PREÇOS ------------------- */
let precoPorCategoria = {
    "PALETAS FRUTIVERÃO": 18,
    "AO LEITE FRUTIVERÃO": 8,
    "TROPICAL FRUTIVERÃO": 6,
    "ESPECIAL FRUTVERÃO": 13,
    "LANÇAMENTOS": null
};

let precosLancamentos = {
    "Pistache": 16,
    "Unicórnio": 10
};

/* ------------------- CATEGORIAS ------------------- */
let categorias = {
    "PALETAS FRUTIVERÃO": [
        "Raffaello","Oreo","Ferrero","Kinder Ovo","Kinder Bueno","M&M","Choco Maltine",
        "Milk Trufado","Babalu","Blue Ice","Sensação","Morango","Maracujá","Açaí",
        "Iogurte c/ Amora","Menta c/ Chocolate","Paçoca","Capuccino","Banana com Avelã",
        "Coco c/ Abobora","Coco c/ Doce de Leite","Tapioca","Abacaxi Zero"
    ],

    "AO LEITE FRUTIVERÃO": [
        "Morango","Chocolate","Leite Condensado","Milho-Verde","Açaí c/ Morango",
        "Coco","Coco Queimado","Abóbora c/ Coco","Amendoim","Abacate","Blue Ice"
    ],

    "TROPICAL FRUTIVERÃO": [
        "Uva","Limão","Maracujá","Manga","Abacaxi","Melancia","Tangerina",
        "Maçã Verde","Groselha","Tutti Frutti","Pinta Língua"
    ],

    "ESPECIAL FRUTVERÃO": [
        "Skimo morango",
        "Skimo ao leite",
        "Milk trufado",
        "Brigadeiro",
        "Chococo",
        "Torta de limão",
        "Itu napolitano",
        "Frutblito",
        "Sunday de chocolate",
        "Sundae de Morango"
    ],

    "LANÇAMENTOS": [
        "Pistache","Unicórnio"
    ]
};

let id = 1;

/* ------------------- LOCALSTORAGE ------------------- */
let total = Number(localStorage.getItem("totalVendas")) || 0;
let dinheiro = Number(localStorage.getItem("dinheiro")) || 0;

let estoqueSalvo = JSON.parse(localStorage.getItem("estoque")) || {};
let vendidoSalvo = JSON.parse(localStorage.getItem("vendido")) || {};

let cartao = total - dinheiro;
if (cartao < 0) cartao = 0;

/* ------------------- FUNÇÕES ------------------- */

function toggle(cat) {
    let el = document.getElementById("cat_" + cat);
    el.style.display = el.style.display === "block" ? "none" : "block";
}

function recalcularTotal() {
    let novoTotal = 0;
    let i = 1;

    for (let cat in categorias) {
        categorias[cat].forEach(sabor => {
            let preco = precoPorCategoria[cat];
            if (cat === "LANÇAMENTOS") preco = precosLancamentos[sabor];

            let vend = Number(document.getElementById("vend_" + i).innerText);
            novoTotal += vend * preco;

            i++;
        });
    }

    total = novoTotal;
    document.getElementById("valorTotal").innerText = total.toFixed(2);

    atualizarFinanceiro();
}

function atualizar(id) {
    let est = Number(document.getElementById("est_" + id).innerText);
    let vend = Number(document.getElementById("vend_" + id).innerText);
    let resto = est - vend;

    if (resto < 0) resto = 0;

    document.getElementById("resto_" + id).innerText = "Restante: " + resto;

    let item = document.getElementById("item_" + id);
    if (resto === 0) item.classList.add("zero"); else item.classList.remove("zero");

    estoqueSalvo[id] = est;
    vendidoSalvo[id] = vend;

    salvar();
    recalcularTotal();
}

function add(tipo, id) {
    let campo = document.getElementById(tipo + "_" + id);
    campo.innerText = Number(campo.innerText) + 1;
    atualizar(id);
}

function remove(tipo, id) {
    let campo = document.getElementById(tipo + "_" + id);
    if (Number(campo.innerText) > 0) campo.innerText--;
    atualizar(id);
}

function salvar() {
    localStorage.setItem("estoque", JSON.stringify(estoqueSalvo));
    localStorage.setItem("vendido", JSON.stringify(vendidoSalvo));
    localStorage.setItem("totalVendas", total.toFixed(2));
    localStorage.setItem("dinheiro", dinheiro.toFixed(2));
}

/* ------------------- NOVA COMISSÃO ------------------- */

function atualizarFinanceiro() {
    dinheiro = Number(document.getElementById("campoDinheiro").value) || 0;

    cartao = total - dinheiro;
    if (cartao < 0) cartao = 0;

    // NOVA REGRA:
    let cartaoLiquido = cartao * 0.95;      // tira 5%
    let base = dinheiro + cartaoLiquido;    // soma com dinheiro
    comissao = base * 0.30;                 // pega 30%

    document.getElementById("campoCartao").innerText = "R$ " + cartao.toFixed(2);
    document.getElementById("campoComissao").innerText = "R$ " + comissao.toFixed(2);

    salvar();
}

/* ------------------- GERAR RELATÓRIO ------------------- */

function gerarRelatorio() {

    let texto = "RELATÓRIO DE VENDAS - SORVETES\n";
    texto += "---------------------------------------\n\n";

    let i = 1;

    for (let cat in categorias) {
        texto += `\n=== ${cat} ===\n`;

        categorias[cat].forEach(sabor => {
            let preco = precoPorCategoria[cat];
            if (cat === "LANÇAMENTOS") preco = precosLancamentos[sabor];

            let est = estoqueSalvo[i] || 0;
            let vend = vendidoSalvo[i] || 0;
            let resto = est - vend;
            if (resto < 0) resto = 0;

            texto += `\n${sabor}\n`;
            texto += `Preço: R$ ${preco}\n`;
            texto += `Estoque: ${est}\n`;
            texto += `Vendido: ${vend}\n`;
            texto += `Restante: ${resto}\n`;

            i++;
        });
    }

    // NOVA REGRA PARA O RELATÓRIO
    let cartaoLiquido = cartao * 0.95;
    let base = dinheiro + cartaoLiquido;
    let comissaoCalc = base * 0.30;

    texto += "\n---------------------------------------\n";
    texto += `TOTAL EM VENDAS: R$ ${total.toFixed(2)}\n`;
    texto += `VENDAS EM DINHEIRO: R$ ${dinheiro.toFixed(2)}\n`;
    texto += `VENDAS NO CARTÃO: R$ ${cartao.toFixed(2)}\n`;
    texto += `COMISSÃO: R$ ${comissaoCalc.toFixed(2)}\n`;
    texto += "---------------------------------------\n";
    texto += "Relatório gerado automaticamente.\n";

    let blob = new Blob([texto], { type: "text/plain" });
    let url = URL.createObjectURL(blob);

    let a = document.createElement("a");
    a.href = url;
    a.download = "relatorio_sorvetes.txt";
    a.click();

    URL.revokeObjectURL(url);
}

function limparTudo() {
    localStorage.clear();
    location.reload();
}
</script>

</head>
<body>

<h1>Controle de Sorvetes</h1>

<div id="conteudo">

<script>
for (let cat in categorias) {
    document.write(`<button class="cat-btn" onclick="toggle('${cat}')">${cat}</button>`);
    document.write(`<div id="cat_${cat}" class="categoria">`);

    categorias[cat].forEach(sabor => {
        let preco = precoPorCategoria[cat];
        if (cat === "LANÇAMENTOS") preco = precosLancamentos[sabor];

        let e = estoqueSalvo[id] || 0;
        let v = vendidoSalvo[id] || 0;
        let r = Math.max(0, e - v);

        document.write(`
            <div class="item ${r === 0 ? "zero" : ""}" id="item_${id}">
                <div class="nome">${sabor}</div>
                <div class="valor">Preço: R$ ${preco}</div>
                <div class="restante" id="resto_${id}">Restante: ${r}</div>

                <div class="linha">
                    <div class="controls">
                        <span>Estoque</span>
                        <button class="btn menos" onclick="remove('est', ${id})">-</button>
                        <span class="numero" id="est_${id}">${e}</span>
                        <button class="btn mais" onclick="add('est', ${id})">+</button>
                    </div>
                </div>

                <div class="linha">
                    <div class="controls">
                        <span>Vendido</span>
                        <button class="btn menos" onclick="remove('vend', ${id})">-</button>
                        <span class="numero" id="vend_${id}">${v}</span>
                        <button class="btn mais" onclick="add('vend', ${id})">+</button>
                    </div>
                </div>
            </div>
        `);

        id++;
    });

    document.write("</div>");
}
</script>

</div>

<!-- TOTAL EM VENDAS --> 
<div id="totalVendas">
    TOTAL EM VENDAS: R$ <span id="valorTotal">${total.toFixed(2)}</span>
</div>

<!-- DINHEIRO -->
<div class="caixa-info">
    VENDAS EM DINHEIRO:<br>
    <input id="campoDinheiro" type="number" step="0.01" value="${dinheiro}" 
           oninput="atualizarFinanceiro()"
           style="width: 90%; margin-top: 10px; padding: 12px; border-radius: 10px; border: 1px solid #ccc; font-size: 22px; text-align: center;">
</div>

<!-- CARTÃO -->
<div class="caixa-info">
    VENDAS NO CARTÃO:<br>
    <span id="campoCartao">R$ ${cartao.toFixed(2)}</span>
</div>

<!-- COMISSÃO -->
<div class="caixa-info" style="background:#fff2cc; color:#8a6d00;">
    COMISSÃO:<br>
    <span id="campoComissao">R$ ${comissao.toFixed(2)}</span>
</div>

<!-- BOTÃO GERAR RELATÓRIO -->
<button id="relatorio" onclick="gerarRelatorio()">GERAR RELATÓRIO</button>

<!-- BOTÃO LIMPAR -->
<button id="limpar" onclick="limparTudo()">LIMPAR TUDO</button>

<script>
recalcularTotal();
</script>

</body>
</html>